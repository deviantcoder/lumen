{% extends "_base.html" %}

{% load static %}
{% load widget_tweaks %}

{% block content %}
<div class="container p-0 col-lg-6 col-md-10 vh-100 d-flex flex-column pt-76">
    <div class="d-flex align-items-center p-2 me-2 ms-2 rounded-3 bg-cold-grey">
        <a href="{% url 'chat:inbox' %}" class="btn btn-link text-white me-3 p-0">
            <i class="bi bi-chevron-left fs-4"></i>
        </a>
        <div class="d-flex align-items-center">
            <img src="{{ other_user.profile.image_or_default }}" class="profile-img me-2">
            <div class="d-flex align-items-center">
                <a href="{% url 'profiles:profile' other_user.username %}" class="fw-semibold text-white text-decoration-none">{{ other_user.username }}</a>
                <div class="d-flex flex-column">
                    <div id="online_status" class="d-flex align-items-center gap-1"></div>
                </div>
            </div>
        </div>
    </div>
    <div class="flex-grow-1 overflow-auto p-3 d-flex flex-column" id='chat_container'>
        <div class="flex-grow-1 overflow-auto p-3 d-flex flex-column" id='chat_messages'>
            {% for message in chat_messages reversed %}
                {% include 'chat/partials/message.html' %}
            {% endfor %}         
        </div>
        <div class="d-flex mb-2 d-none" id="typing_indicator">
            <div class="d-flex flex-column px-3 py-2 rounded-4 bg-light text-dark">
                <div class="d-flex align-items-center justify-content-center gap-1 typing-circles">
                    <i class="bi bi-circle-fill"></i>
                    <i class="bi bi-circle-fill"></i>
                    <i class="bi bi-circle-fill"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="p-2 mb-1">
        <form id="chat_message_form" class="input-group gap-2"
            hx-ext="ws"
            ws-connect="/ws/chat/{{ chat.id }}/"
            ws-send 
            _="on htmx:wsAfterSend reset() me"
        >
            {% csrf_token %}
            {% render_field form.content class="form-control p-2 rounded-3 border-0 bg-cold-grey" autofocus=True id="chat-input" %}
            <button class="btn text-white border-0 rounded-3 bg-warm-gradient" type="submit">
                <i class="bi bi-send-fill fs-5 px-2"></i>
            </button>
        </form>
    </div>
</div>
{% block additional_js %}
<script src="{% static 'js/chat.js' %}"></script>
{% endblock additional_js %}
{% endblock content %}
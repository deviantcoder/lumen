{% load humanize %}

{% for post in posts %}
    <div class="post-card">
        <div class="d-flex align-items-center justify-content-between p-2">
            <div class="d-flex align-items-center">
                <img src="{{ post.author.profile.image_or_default }}" class="post-user-avatar" alt="User avatar">
                <a href="{% url 'profiles:profile' post.author.username %}" class="fw-bold text-white small text-decoration-none me-2">{{ post.author }}</a>
                <span class="text-muted small">â€¢ {{ post.created|naturaltime }}</span>
            </div>
            <button class="btn border-0 cursor-pointer">
                <i class="bi bi-three-dots"></i>
            </button>
        </div>
        {% if not post.media.count > 1 %}
            {% with media=post.media.first %}
                {% if media.media_type == 'image' %}
                    <div class="post-image-wrapper">
                        <img src="{{ media.file.url }}" class="post-image" alt="Post image">
                    </div>
                {% else %}
                    <div class="post-video-wrapper">
                        <video class="post-video" controls preload="metadata">
                            <source src="{{ media.file.url }}" type="video/mp4">
                        </video>
                    </div>
                {% endif %}
            {% endwith %}
        {% else %}
            <div id="carousel-{{ post.id }}" class="carousel slide">
                <div class="carousel-indicators">
                    {% for media in post.media.all %}
                        <button type="button" data-bs-target="#carousel-{{ post.id }}" data-bs-slide-to="{{ forloop.counter0 }}" class="{% if forloop.first %}active{% endif %}" aria-current="{% if forloop.first %}true{% endif %}" aria-label="Slide {{ forloop.counter }}">
                        </button>
                    {% endfor %}
                </div>
                <div class="carousel-inner">
                    {% for media in post.media.all %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            {% if media.media_type == 'image' %}
                                <div class="post-image-wrapper">
                                    <img src="{{ media.file.url }}" class="post-image" alt="Post image">
                                </div>
                            {% else %}
                                <div class="post-video-wrapper">
                                    <video class="post-video" controls preload="metadata">
                                        <source src="{{ media.file.url }}" type="video/mp4">
                                    </video>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
                <button class="carousel-control-prev" type="button" data-bs-target="#carousel-{{ post.id }}" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Previous</span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#carousel-{{ post.id }}" data-bs-slide="next">
                    <span class="carousel-control-next-icon" aria-hidden="true"></span>
                    <span class="visually-hidden">Next</span>
                </button>
            </div>
        {% endif %}
        <div class="p-2">
            {% include 'posts/includes/post_controls.html' %}
            {% if post.caption %}
                <div class="ps-2 mb-2">
                    <a href="#" class="fw-bold me-2 text-decoration-none">{{ user.username }}</a>
                    {{ post.caption }}
                </div>
            {% endif %}
            <div class="ps-2 mb-2">
                {% for tag in post.tags.all %}
                    <a href="" class="text-decoration-none fw-bold small me-1">#{{ tag }}</a>
                {% endfor %}
            </div>
            <div class="ps-2 mb-2">
                {% with comment_count=post.comments.count %}
                <a href="" class="text-muted small text-decoration-none cursor-pointer"
                    hx-get="{% url 'posts:post_preview' post.pk %}"
                    hx-target="#modal-body"
                    hx-swap="innerHTML"
                    data-bs-toggle="modal"
                    data-bs-target="#modal"
                >View {{ comment_count }} comment{{ comment_count|pluralize:'s' }}</a>
                {% endwith %}
            </div>
        </div>
    </div>
{% endfor %}